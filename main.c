#include <string.h>
#include <avr/io.h>
#include <avr/interrupt.h>
#include <avr/pgmspace.h>

typedef uint8_t u8;
typedef uint16_t u16;
typedef uint32_t u32;

typedef int8_t i8;
typedef int16_t i16;
typedef int32_t i32;

static u8 spi_receive(void)
{
	while(!(SPSR & (1 << SPIF)));
	return SPDR;
}

#define _TIME_HSYNC                4.7
#define _TIME_VSYNC               58.85
#define _TIME_ACTIVE              46
#define _NTSC_TIME_SCANLINE       63.55
#define _NTSC_TIME_OUTPUT_START   12
#define _NTSC_LINE_FRAME         262
#define _NTSC_LINE_START_VSYNC     0
#define _NTSC_LINE_STOP_VSYNC      3
#define _NTSC_LINE_DISPLAY       216

#define VIDEO_OUT                   PORTD
#define VIDEO_DIR                   DDRD
#define VIDEO_PIN                  1

#define XCK_DIR                     DDRD
#define XCK_PIN                    4

#define SYNC_OUT                    PORTB
#define SYNC_DIR                    DDRB
#define SYNC_PIN                   1

#define VIDEO_WIDTH               40
#define VIDEO_HEIGHT              25

#define CELL_WIDTH                 8
#define CELL_HEIGHT                8

#define _CYCLES_PER_US \
		(F_CPU / 1000000)

#define _CYCLES_VSYNC \
		((_TIME_VSYNC * _CYCLES_PER_US) - 1)

#define _CYCLES_HSYNC \
		((_TIME_HSYNC * _CYCLES_PER_US) - 1)

#define _NTSC_LINE_MID \
		((_NTSC_LINE_FRAME - _NTSC_LINE_DISPLAY) / 2 + \
		_NTSC_LINE_DISPLAY / 2 + _NTSC_LINE_STOP_VSYNC)

#define _NTSC_CYCLES_SCANLINE \
		((_NTSC_TIME_SCANLINE * _CYCLES_PER_US) - 1)

#define _NTSC_CYCLES_OUTPUT_START \
		((_NTSC_TIME_OUTPUT_START * _CYCLES_PER_US) - 1)

static const u8 font[2048] PROGMEM =
{
	0x00, 0xF0, 0x0F, 0xFF, 0x00, 0xF0, 0x0F, 0xFF, 0x00, 0xF0, 0x0F, 0xFF, 0x00, 0xF0, 0x0F, 0xFF, 0x80, 0x01, 0xFF, 0x18, 0x18, 0x18, 0x00, 0x18, 0xFF, 0x18, 0x00, 0x18, 0x00, 0x18, 0x00, 0x18, 0x00, 0x30, 0x6C, 0x6C, 0x30, 0x00, 0x38, 0x60, 0x18, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x7C, 0x30, 0x78, 0x78, 0x1C, 0xFC, 0x38, 0xFC, 0x78, 0x78, 0x00, 0x00, 0x18, 0x00, 0x60, 0x78, 0x7C, 0x30, 0xFC, 0x3C, 0xF8, 0xFE, 0xFE, 0x3C, 0xCC, 0x78, 0x1E, 0xE6, 0xF0, 0xC6, 0xC6, 0x38, 0xFC, 0x78, 0xFC, 0x78, 0xFC, 0xCC, 0xCC, 0xC6, 0xC6, 0xCC, 0xFE, 0x78, 0xC0, 0x78, 0x10, 0x00, 0x30, 0x00, 0xE0, 0x00, 0x1C, 0x00, 0x38, 0x00, 0xE0, 0x30, 0x0C, 0xE0, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1C, 0x18, 0xE0, 0x76, 0xAA,
	0x00, 0xF0, 0x0F, 0xFF, 0x00, 0xF0, 0x0F, 0xFF, 0x00, 0xF0, 0x0F, 0xFF, 0x00, 0xF0, 0x0F, 0xFF, 0xE0, 0x07, 0xFF, 0x18, 0x18, 0x18, 0x00, 0x18, 0xFF, 0x18, 0x00, 0x18, 0x00, 0x18, 0x00, 0x18, 0x00, 0x78, 0x6C, 0x6C, 0x7C, 0xC6, 0x6C, 0x60, 0x30, 0x30, 0x66, 0x30, 0x00, 0x00, 0x00, 0x0C, 0xC6, 0x70, 0xCC, 0xCC, 0x3C, 0xC0, 0x60, 0xCC, 0xCC, 0xCC, 0x30, 0x30, 0x30, 0x00, 0x30, 0xCC, 0xC6, 0x78, 0x66, 0x66, 0x6C, 0x62, 0x62, 0x66, 0xCC, 0x30, 0x0C, 0x66, 0x60, 0xEE, 0xE6, 0x6C, 0x66, 0xCC, 0x66, 0xCC, 0xB4, 0xCC, 0xCC, 0xC6, 0xC6, 0xCC, 0xC6, 0x60, 0x60, 0x18, 0x38, 0x00, 0x30, 0x00, 0x60, 0x00, 0x0C, 0x00, 0x6C, 0x00, 0x60, 0x00, 0x00, 0x60, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x18, 0x30, 0xDC, 0x55,
	0x00, 0xF0, 0x0F, 0xFF, 0x00, 0xF0, 0x0F, 0xFF, 0x00, 0xF0, 0x0F, 0xFF, 0x00, 0xF0, 0x0F, 0xFF, 0xF8, 0x1F, 0xC3, 0x18, 0x3C, 0x18, 0x00, 0x18, 0x7E, 0x18, 0x00, 0x18, 0x00, 0x18, 0x00, 0x18, 0x00, 0x78, 0x6C, 0xFE, 0xC0, 0xCC, 0x38, 0xC0, 0x60, 0x18, 0x3C, 0x30, 0x00, 0x00, 0x00, 0x18, 0xCE, 0x30, 0x0C, 0x0C, 0x6C, 0xF8, 0xC0, 0x0C, 0xCC, 0xCC, 0x30, 0x30, 0x60, 0xFC, 0x18, 0x0C, 0xDE, 0xCC, 0x66, 0xC0, 0x66, 0x68, 0x68, 0xC0, 0xCC, 0x30, 0x0C, 0x6C, 0x60, 0xFE, 0xF6, 0xC6, 0x66, 0xCC, 0x66, 0xE0, 0x30, 0xCC, 0xCC, 0xC6, 0x6C, 0xCC, 0x8C, 0x60, 0x30, 0x18, 0x6C, 0x00, 0x18, 0x78, 0x60, 0x78, 0x0C, 0x78, 0x60, 0x76, 0x6C, 0x70, 0x0C, 0x66, 0x30, 0xCC, 0xF8, 0x78, 0xDC, 0x76, 0xDC, 0x7C, 0x7C, 0xCC, 0xCC, 0xC6, 0xC6, 0xCC, 0xFC, 0x30, 0x18, 0x30, 0x00, 0xAA,
	0x00, 0xF0, 0x0F, 0xFF, 0x00, 0xF0, 0x0F, 0xFF, 0x00, 0xF0, 0x0F, 0xFF, 0x00, 0xF0, 0x0F, 0xFF, 0xFE, 0x7F, 0xC3, 0x1F, 0x3C, 0x18, 0x1F, 0x1F, 0x7E, 0xF8, 0xFF, 0xFF, 0xF8, 0xF8, 0xFF, 0xFF, 0x00, 0x30, 0x00, 0x6C, 0x78, 0x18, 0x76, 0x00, 0x60, 0x18, 0xFF, 0xFC, 0x00, 0xFC, 0x00, 0x30, 0xDE, 0x30, 0x38, 0x38, 0xCC, 0x0C, 0xF8, 0x18, 0x78, 0x7C, 0x00, 0x00, 0xC0, 0x00, 0x0C, 0x18, 0xDE, 0xCC, 0x7C, 0xC0, 0x66, 0x78, 0x78, 0xC0, 0xFC, 0x30, 0x0C, 0x78, 0x60, 0xFE, 0xDE, 0xC6, 0x7C, 0xCC, 0x7C, 0x70, 0x30, 0xCC, 0xCC, 0xD6, 0x38, 0x78, 0x18, 0x60, 0x18, 0x18, 0xC6, 0x00, 0x00, 0x0C, 0x7C, 0xCC, 0x7C, 0xCC, 0xF0, 0xCC, 0x76, 0x30, 0x0C, 0x6C, 0x30, 0xFE, 0xCC, 0xCC, 0x66, 0xCC, 0x76, 0xC0, 0x30, 0xCC, 0xCC, 0xD6, 0x6C, 0xCC, 0x98, 0xE0, 0x00, 0x1C, 0x00, 0x55,
	0x00, 0x00, 0x00, 0x00, 0xF0, 0xF0, 0xF0, 0xF0, 0x0F, 0x0F, 0x0F, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0x7F, 0xC3, 0x1F, 0x7E, 0x18, 0x1F, 0x1F, 0x3C, 0xF8, 0xFF, 0xFF, 0xF8, 0xF8, 0xFF, 0xFF, 0x00, 0x30, 0x00, 0xFE, 0x0C, 0x30, 0xDC, 0x00, 0x60, 0x18, 0x3C, 0x30, 0x00, 0x00, 0x00, 0x60, 0xF6, 0x30, 0x60, 0x0C, 0xFE, 0x0C, 0xCC, 0x30, 0xCC, 0x0C, 0x00, 0x00, 0x60, 0x00, 0x18, 0x30, 0xDE, 0xFC, 0x66, 0xC0, 0x66, 0x68, 0x68, 0xCE, 0xCC, 0x30, 0xCC, 0x6C, 0x62, 0xD6, 0xCE, 0xC6, 0x60, 0xDC, 0x6C, 0x1C, 0x30, 0xCC, 0xCC, 0xFE, 0x38, 0x30, 0x32, 0x60, 0x0C, 0x18, 0x00, 0x00, 0x00, 0x7C, 0x66, 0xC0, 0xCC, 0xFC, 0x60, 0xCC, 0x66, 0x30, 0x0C, 0x78, 0x30, 0xFE, 0xCC, 0xCC, 0x66, 0xCC, 0x66, 0x78, 0x30, 0xCC, 0xCC, 0xFE, 0x38, 0xCC, 0x30, 0x30, 0x18, 0x30, 0x00, 0xAA,
	0x00, 0x00, 0x00, 0x00, 0xF0, 0xF0, 0xF0, 0xF0, 0x0F, 0x0F, 0x0F, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF, 0xF8, 0x1F, 0xC3, 0x00, 0x7E, 0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x6C, 0xF8, 0x66, 0xCC, 0x00, 0x30, 0x30, 0x66, 0x30, 0x30, 0x00, 0x30, 0xC0, 0xE6, 0x30, 0xCC, 0xCC, 0x0C, 0xCC, 0xCC, 0x30, 0xCC, 0x18, 0x30, 0x30, 0x30, 0xFC, 0x30, 0x00, 0xC0, 0xCC, 0x66, 0x66, 0x6C, 0x62, 0x60, 0x66, 0xCC, 0x30, 0xCC, 0x66, 0x66, 0xC6, 0xC6, 0x6C, 0x60, 0x78, 0x66, 0xCC, 0x30, 0xCC, 0x78, 0xEE, 0x6C, 0x30, 0x66, 0x60, 0x06, 0x18, 0x00, 0x00, 0x00, 0xCC, 0x66, 0xCC, 0xCC, 0xC0, 0x60, 0x7C, 0x66, 0x30, 0xCC, 0x6C, 0x30, 0xD6, 0xCC, 0xCC, 0x7C, 0x7C, 0x60, 0x0C, 0x34, 0xCC, 0x78, 0xFE, 0x6C, 0x7C, 0x64, 0x30, 0x18, 0x30, 0x00, 0x55,
	0x00, 0x00, 0x00, 0x00, 0xF0, 0xF0, 0xF0, 0xF0, 0x0F, 0x0F, 0x0F, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF, 0xE0, 0x07, 0xFF, 0x00, 0xFF, 0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x18, 0x18, 0x18, 0x18, 0x00, 0x30, 0x00, 0x6C, 0x30, 0xC6, 0x76, 0x00, 0x18, 0x60, 0x00, 0x00, 0x30, 0x00, 0x30, 0x80, 0x7C, 0xFC, 0xFC, 0x78, 0x1E, 0x78, 0x78, 0x30, 0x78, 0x70, 0x30, 0x30, 0x18, 0x00, 0x60, 0x30, 0x78, 0xCC, 0xFC, 0x3C, 0xF8, 0xFE, 0xF0, 0x3E, 0xCC, 0x78, 0x78, 0xE6, 0xFE, 0xC6, 0xC6, 0x38, 0xF0, 0x1C, 0xE6, 0x78, 0x78, 0xFC, 0x30, 0xC6, 0xC6, 0x78, 0xFE, 0x78, 0x02, 0x78, 0x00, 0x00, 0x00, 0x76, 0xDC, 0x78, 0x76, 0x78, 0xF0, 0x0C, 0xE6, 0x78, 0xCC, 0xE6, 0x78, 0xC6, 0xCC, 0x78, 0x60, 0x0C, 0xF0, 0xF8, 0x18, 0x76, 0x30, 0x6C, 0xC6, 0x0C, 0xFC, 0x1C, 0x18, 0xE0, 0x00, 0xAA,
	0x00, 0x00, 0x00, 0x00, 0xF0, 0xF0, 0xF0, 0xF0, 0x0F, 0x0F, 0x0F, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF, 0x80, 0x01, 0xFF, 0x00, 0xFF, 0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF8, 0x00, 0x00, 0x78, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x1E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x55,

	(u8)~0x00, (u8)~0xF0, (u8)~0x0F, (u8)~0xFF, (u8)~0x00, (u8)~0xF0, (u8)~0x0F, (u8)~0xFF, (u8)~0x00, (u8)~0xF0, (u8)~0x0F, (u8)~0xFF, (u8)~0x00, (u8)~0xF0, (u8)~0x0F, (u8)~0xFF, (u8)~0x80, (u8)~0x01, (u8)~0xFF, (u8)~0x18, (u8)~0x18, (u8)~0x18, (u8)~0x00, (u8)~0x18, (u8)~0xFF, (u8)~0x18, (u8)~0x00, (u8)~0x18, (u8)~0x00, (u8)~0x18, (u8)~0x00, (u8)~0x18, (u8)~0x00, (u8)~0x30, (u8)~0x6C, (u8)~0x6C, (u8)~0x30, (u8)~0x00, (u8)~0x38, (u8)~0x60, (u8)~0x18, (u8)~0x60, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x06, (u8)~0x7C, (u8)~0x30, (u8)~0x78, (u8)~0x78, (u8)~0x1C, (u8)~0xFC, (u8)~0x38, (u8)~0xFC, (u8)~0x78, (u8)~0x78, (u8)~0x00, (u8)~0x00, (u8)~0x18, (u8)~0x00, (u8)~0x60, (u8)~0x78, (u8)~0x7C, (u8)~0x30, (u8)~0xFC, (u8)~0x3C, (u8)~0xF8, (u8)~0xFE, (u8)~0xFE, (u8)~0x3C, (u8)~0xCC, (u8)~0x78, (u8)~0x1E, (u8)~0xE6, (u8)~0xF0, (u8)~0xC6, (u8)~0xC6, (u8)~0x38, (u8)~0xFC, (u8)~0x78, (u8)~0xFC, (u8)~0x78, (u8)~0xFC, (u8)~0xCC, (u8)~0xCC, (u8)~0xC6, (u8)~0xC6, (u8)~0xCC, (u8)~0xFE, (u8)~0x78, (u8)~0xC0, (u8)~0x78, (u8)~0x10, (u8)~0x00, (u8)~0x30, (u8)~0x00, (u8)~0xE0, (u8)~0x00, (u8)~0x1C, (u8)~0x00, (u8)~0x38, (u8)~0x00, (u8)~0xE0, (u8)~0x30, (u8)~0x0C, (u8)~0xE0, (u8)~0x70, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x10, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x1C, (u8)~0x18, (u8)~0xE0, (u8)~0x76, (u8)~0xAA,
	(u8)~0x00, (u8)~0xF0, (u8)~0x0F, (u8)~0xFF, (u8)~0x00, (u8)~0xF0, (u8)~0x0F, (u8)~0xFF, (u8)~0x00, (u8)~0xF0, (u8)~0x0F, (u8)~0xFF, (u8)~0x00, (u8)~0xF0, (u8)~0x0F, (u8)~0xFF, (u8)~0xE0, (u8)~0x07, (u8)~0xFF, (u8)~0x18, (u8)~0x18, (u8)~0x18, (u8)~0x00, (u8)~0x18, (u8)~0xFF, (u8)~0x18, (u8)~0x00, (u8)~0x18, (u8)~0x00, (u8)~0x18, (u8)~0x00, (u8)~0x18, (u8)~0x00, (u8)~0x78, (u8)~0x6C, (u8)~0x6C, (u8)~0x7C, (u8)~0xC6, (u8)~0x6C, (u8)~0x60, (u8)~0x30, (u8)~0x30, (u8)~0x66, (u8)~0x30, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x0C, (u8)~0xC6, (u8)~0x70, (u8)~0xCC, (u8)~0xCC, (u8)~0x3C, (u8)~0xC0, (u8)~0x60, (u8)~0xCC, (u8)~0xCC, (u8)~0xCC, (u8)~0x30, (u8)~0x30, (u8)~0x30, (u8)~0x00, (u8)~0x30, (u8)~0xCC, (u8)~0xC6, (u8)~0x78, (u8)~0x66, (u8)~0x66, (u8)~0x6C, (u8)~0x62, (u8)~0x62, (u8)~0x66, (u8)~0xCC, (u8)~0x30, (u8)~0x0C, (u8)~0x66, (u8)~0x60, (u8)~0xEE, (u8)~0xE6, (u8)~0x6C, (u8)~0x66, (u8)~0xCC, (u8)~0x66, (u8)~0xCC, (u8)~0xB4, (u8)~0xCC, (u8)~0xCC, (u8)~0xC6, (u8)~0xC6, (u8)~0xCC, (u8)~0xC6, (u8)~0x60, (u8)~0x60, (u8)~0x18, (u8)~0x38, (u8)~0x00, (u8)~0x30, (u8)~0x00, (u8)~0x60, (u8)~0x00, (u8)~0x0C, (u8)~0x00, (u8)~0x6C, (u8)~0x00, (u8)~0x60, (u8)~0x00, (u8)~0x00, (u8)~0x60, (u8)~0x30, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x30, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x30, (u8)~0x18, (u8)~0x30, (u8)~0xDC, (u8)~0x55,
	(u8)~0x00, (u8)~0xF0, (u8)~0x0F, (u8)~0xFF, (u8)~0x00, (u8)~0xF0, (u8)~0x0F, (u8)~0xFF, (u8)~0x00, (u8)~0xF0, (u8)~0x0F, (u8)~0xFF, (u8)~0x00, (u8)~0xF0, (u8)~0x0F, (u8)~0xFF, (u8)~0xF8, (u8)~0x1F, (u8)~0xC3, (u8)~0x18, (u8)~0x3C, (u8)~0x18, (u8)~0x00, (u8)~0x18, (u8)~0x7E, (u8)~0x18, (u8)~0x00, (u8)~0x18, (u8)~0x00, (u8)~0x18, (u8)~0x00, (u8)~0x18, (u8)~0x00, (u8)~0x78, (u8)~0x6C, (u8)~0xFE, (u8)~0xC0, (u8)~0xCC, (u8)~0x38, (u8)~0xC0, (u8)~0x60, (u8)~0x18, (u8)~0x3C, (u8)~0x30, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x18, (u8)~0xCE, (u8)~0x30, (u8)~0x0C, (u8)~0x0C, (u8)~0x6C, (u8)~0xF8, (u8)~0xC0, (u8)~0x0C, (u8)~0xCC, (u8)~0xCC, (u8)~0x30, (u8)~0x30, (u8)~0x60, (u8)~0xFC, (u8)~0x18, (u8)~0x0C, (u8)~0xDE, (u8)~0xCC, (u8)~0x66, (u8)~0xC0, (u8)~0x66, (u8)~0x68, (u8)~0x68, (u8)~0xC0, (u8)~0xCC, (u8)~0x30, (u8)~0x0C, (u8)~0x6C, (u8)~0x60, (u8)~0xFE, (u8)~0xF6, (u8)~0xC6, (u8)~0x66, (u8)~0xCC, (u8)~0x66, (u8)~0xE0, (u8)~0x30, (u8)~0xCC, (u8)~0xCC, (u8)~0xC6, (u8)~0x6C, (u8)~0xCC, (u8)~0x8C, (u8)~0x60, (u8)~0x30, (u8)~0x18, (u8)~0x6C, (u8)~0x00, (u8)~0x18, (u8)~0x78, (u8)~0x60, (u8)~0x78, (u8)~0x0C, (u8)~0x78, (u8)~0x60, (u8)~0x76, (u8)~0x6C, (u8)~0x70, (u8)~0x0C, (u8)~0x66, (u8)~0x30, (u8)~0xCC, (u8)~0xF8, (u8)~0x78, (u8)~0xDC, (u8)~0x76, (u8)~0xDC, (u8)~0x7C, (u8)~0x7C, (u8)~0xCC, (u8)~0xCC, (u8)~0xC6, (u8)~0xC6, (u8)~0xCC, (u8)~0xFC, (u8)~0x30, (u8)~0x18, (u8)~0x30, (u8)~0x00, (u8)~0xAA,
	(u8)~0x00, (u8)~0xF0, (u8)~0x0F, (u8)~0xFF, (u8)~0x00, (u8)~0xF0, (u8)~0x0F, (u8)~0xFF, (u8)~0x00, (u8)~0xF0, (u8)~0x0F, (u8)~0xFF, (u8)~0x00, (u8)~0xF0, (u8)~0x0F, (u8)~0xFF, (u8)~0xFE, (u8)~0x7F, (u8)~0xC3, (u8)~0x1F, (u8)~0x3C, (u8)~0x18, (u8)~0x1F, (u8)~0x1F, (u8)~0x7E, (u8)~0xF8, (u8)~0xFF, (u8)~0xFF, (u8)~0xF8, (u8)~0xF8, (u8)~0xFF, (u8)~0xFF, (u8)~0x00, (u8)~0x30, (u8)~0x00, (u8)~0x6C, (u8)~0x78, (u8)~0x18, (u8)~0x76, (u8)~0x00, (u8)~0x60, (u8)~0x18, (u8)~0xFF, (u8)~0xFC, (u8)~0x00, (u8)~0xFC, (u8)~0x00, (u8)~0x30, (u8)~0xDE, (u8)~0x30, (u8)~0x38, (u8)~0x38, (u8)~0xCC, (u8)~0x0C, (u8)~0xF8, (u8)~0x18, (u8)~0x78, (u8)~0x7C, (u8)~0x00, (u8)~0x00, (u8)~0xC0, (u8)~0x00, (u8)~0x0C, (u8)~0x18, (u8)~0xDE, (u8)~0xCC, (u8)~0x7C, (u8)~0xC0, (u8)~0x66, (u8)~0x78, (u8)~0x78, (u8)~0xC0, (u8)~0xFC, (u8)~0x30, (u8)~0x0C, (u8)~0x78, (u8)~0x60, (u8)~0xFE, (u8)~0xDE, (u8)~0xC6, (u8)~0x7C, (u8)~0xCC, (u8)~0x7C, (u8)~0x70, (u8)~0x30, (u8)~0xCC, (u8)~0xCC, (u8)~0xD6, (u8)~0x38, (u8)~0x78, (u8)~0x18, (u8)~0x60, (u8)~0x18, (u8)~0x18, (u8)~0xC6, (u8)~0x00, (u8)~0x00, (u8)~0x0C, (u8)~0x7C, (u8)~0xCC, (u8)~0x7C, (u8)~0xCC, (u8)~0xF0, (u8)~0xCC, (u8)~0x76, (u8)~0x30, (u8)~0x0C, (u8)~0x6C, (u8)~0x30, (u8)~0xFE, (u8)~0xCC, (u8)~0xCC, (u8)~0x66, (u8)~0xCC, (u8)~0x76, (u8)~0xC0, (u8)~0x30, (u8)~0xCC, (u8)~0xCC, (u8)~0xD6, (u8)~0x6C, (u8)~0xCC, (u8)~0x98, (u8)~0xE0, (u8)~0x00, (u8)~0x1C, (u8)~0x00, (u8)~0x55,
	(u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0xF0, (u8)~0xF0, (u8)~0xF0, (u8)~0xF0, (u8)~0x0F, (u8)~0x0F, (u8)~0x0F, (u8)~0x0F, (u8)~0xFF, (u8)~0xFF, (u8)~0xFF, (u8)~0xFF, (u8)~0xFE, (u8)~0x7F, (u8)~0xC3, (u8)~0x1F, (u8)~0x7E, (u8)~0x18, (u8)~0x1F, (u8)~0x1F, (u8)~0x3C, (u8)~0xF8, (u8)~0xFF, (u8)~0xFF, (u8)~0xF8, (u8)~0xF8, (u8)~0xFF, (u8)~0xFF, (u8)~0x00, (u8)~0x30, (u8)~0x00, (u8)~0xFE, (u8)~0x0C, (u8)~0x30, (u8)~0xDC, (u8)~0x00, (u8)~0x60, (u8)~0x18, (u8)~0x3C, (u8)~0x30, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x60, (u8)~0xF6, (u8)~0x30, (u8)~0x60, (u8)~0x0C, (u8)~0xFE, (u8)~0x0C, (u8)~0xCC, (u8)~0x30, (u8)~0xCC, (u8)~0x0C, (u8)~0x00, (u8)~0x00, (u8)~0x60, (u8)~0x00, (u8)~0x18, (u8)~0x30, (u8)~0xDE, (u8)~0xFC, (u8)~0x66, (u8)~0xC0, (u8)~0x66, (u8)~0x68, (u8)~0x68, (u8)~0xCE, (u8)~0xCC, (u8)~0x30, (u8)~0xCC, (u8)~0x6C, (u8)~0x62, (u8)~0xD6, (u8)~0xCE, (u8)~0xC6, (u8)~0x60, (u8)~0xDC, (u8)~0x6C, (u8)~0x1C, (u8)~0x30, (u8)~0xCC, (u8)~0xCC, (u8)~0xFE, (u8)~0x38, (u8)~0x30, (u8)~0x32, (u8)~0x60, (u8)~0x0C, (u8)~0x18, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x7C, (u8)~0x66, (u8)~0xC0, (u8)~0xCC, (u8)~0xFC, (u8)~0x60, (u8)~0xCC, (u8)~0x66, (u8)~0x30, (u8)~0x0C, (u8)~0x78, (u8)~0x30, (u8)~0xFE, (u8)~0xCC, (u8)~0xCC, (u8)~0x66, (u8)~0xCC, (u8)~0x66, (u8)~0x78, (u8)~0x30, (u8)~0xCC, (u8)~0xCC, (u8)~0xFE, (u8)~0x38, (u8)~0xCC, (u8)~0x30, (u8)~0x30, (u8)~0x18, (u8)~0x30, (u8)~0x00, (u8)~0xAA,
	(u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0xF0, (u8)~0xF0, (u8)~0xF0, (u8)~0xF0, (u8)~0x0F, (u8)~0x0F, (u8)~0x0F, (u8)~0x0F, (u8)~0xFF, (u8)~0xFF, (u8)~0xFF, (u8)~0xFF, (u8)~0xF8, (u8)~0x1F, (u8)~0xC3, (u8)~0x00, (u8)~0x7E, (u8)~0x18, (u8)~0x18, (u8)~0x18, (u8)~0x3C, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x18, (u8)~0x18, (u8)~0x18, (u8)~0x18, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x6C, (u8)~0xF8, (u8)~0x66, (u8)~0xCC, (u8)~0x00, (u8)~0x30, (u8)~0x30, (u8)~0x66, (u8)~0x30, (u8)~0x30, (u8)~0x00, (u8)~0x30, (u8)~0xC0, (u8)~0xE6, (u8)~0x30, (u8)~0xCC, (u8)~0xCC, (u8)~0x0C, (u8)~0xCC, (u8)~0xCC, (u8)~0x30, (u8)~0xCC, (u8)~0x18, (u8)~0x30, (u8)~0x30, (u8)~0x30, (u8)~0xFC, (u8)~0x30, (u8)~0x00, (u8)~0xC0, (u8)~0xCC, (u8)~0x66, (u8)~0x66, (u8)~0x6C, (u8)~0x62, (u8)~0x60, (u8)~0x66, (u8)~0xCC, (u8)~0x30, (u8)~0xCC, (u8)~0x66, (u8)~0x66, (u8)~0xC6, (u8)~0xC6, (u8)~0x6C, (u8)~0x60, (u8)~0x78, (u8)~0x66, (u8)~0xCC, (u8)~0x30, (u8)~0xCC, (u8)~0x78, (u8)~0xEE, (u8)~0x6C, (u8)~0x30, (u8)~0x66, (u8)~0x60, (u8)~0x06, (u8)~0x18, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0xCC, (u8)~0x66, (u8)~0xCC, (u8)~0xCC, (u8)~0xC0, (u8)~0x60, (u8)~0x7C, (u8)~0x66, (u8)~0x30, (u8)~0xCC, (u8)~0x6C, (u8)~0x30, (u8)~0xD6, (u8)~0xCC, (u8)~0xCC, (u8)~0x7C, (u8)~0x7C, (u8)~0x60, (u8)~0x0C, (u8)~0x34, (u8)~0xCC, (u8)~0x78, (u8)~0xFE, (u8)~0x6C, (u8)~0x7C, (u8)~0x64, (u8)~0x30, (u8)~0x18, (u8)~0x30, (u8)~0x00, (u8)~0x55,
	(u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0xF0, (u8)~0xF0, (u8)~0xF0, (u8)~0xF0, (u8)~0x0F, (u8)~0x0F, (u8)~0x0F, (u8)~0x0F, (u8)~0xFF, (u8)~0xFF, (u8)~0xFF, (u8)~0xFF, (u8)~0xE0, (u8)~0x07, (u8)~0xFF, (u8)~0x00, (u8)~0xFF, (u8)~0x18, (u8)~0x18, (u8)~0x18, (u8)~0x18, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x18, (u8)~0x18, (u8)~0x18, (u8)~0x18, (u8)~0x00, (u8)~0x30, (u8)~0x00, (u8)~0x6C, (u8)~0x30, (u8)~0xC6, (u8)~0x76, (u8)~0x00, (u8)~0x18, (u8)~0x60, (u8)~0x00, (u8)~0x00, (u8)~0x30, (u8)~0x00, (u8)~0x30, (u8)~0x80, (u8)~0x7C, (u8)~0xFC, (u8)~0xFC, (u8)~0x78, (u8)~0x1E, (u8)~0x78, (u8)~0x78, (u8)~0x30, (u8)~0x78, (u8)~0x70, (u8)~0x30, (u8)~0x30, (u8)~0x18, (u8)~0x00, (u8)~0x60, (u8)~0x30, (u8)~0x78, (u8)~0xCC, (u8)~0xFC, (u8)~0x3C, (u8)~0xF8, (u8)~0xFE, (u8)~0xF0, (u8)~0x3E, (u8)~0xCC, (u8)~0x78, (u8)~0x78, (u8)~0xE6, (u8)~0xFE, (u8)~0xC6, (u8)~0xC6, (u8)~0x38, (u8)~0xF0, (u8)~0x1C, (u8)~0xE6, (u8)~0x78, (u8)~0x78, (u8)~0xFC, (u8)~0x30, (u8)~0xC6, (u8)~0xC6, (u8)~0x78, (u8)~0xFE, (u8)~0x78, (u8)~0x02, (u8)~0x78, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x76, (u8)~0xDC, (u8)~0x78, (u8)~0x76, (u8)~0x78, (u8)~0xF0, (u8)~0x0C, (u8)~0xE6, (u8)~0x78, (u8)~0xCC, (u8)~0xE6, (u8)~0x78, (u8)~0xC6, (u8)~0xCC, (u8)~0x78, (u8)~0x60, (u8)~0x0C, (u8)~0xF0, (u8)~0xF8, (u8)~0x18, (u8)~0x76, (u8)~0x30, (u8)~0x6C, (u8)~0xC6, (u8)~0x0C, (u8)~0xFC, (u8)~0x1C, (u8)~0x18, (u8)~0xE0, (u8)~0x00, (u8)~0xAA,
	(u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0xF0, (u8)~0xF0, (u8)~0xF0, (u8)~0xF0, (u8)~0x0F, (u8)~0x0F, (u8)~0x0F, (u8)~0x0F, (u8)~0xFF, (u8)~0xFF, (u8)~0xFF, (u8)~0xFF, (u8)~0x80, (u8)~0x01, (u8)~0xFF, (u8)~0x00, (u8)~0xFF, (u8)~0x18, (u8)~0x18, (u8)~0x18, (u8)~0x18, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x18, (u8)~0x18, (u8)~0x18, (u8)~0x18, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x60, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x60, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0xFF, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0xF8, (u8)~0x00, (u8)~0x00, (u8)~0x78, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0xF0, (u8)~0x1E, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0xF8, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x00, (u8)~0x55,
};

void blank_line(void);
void active_line(void);

static volatile u8 flag = 0;

static u8 video_memory[VIDEO_WIDTH * VIDEO_HEIGHT];
static u8 *video_ptr = video_memory;
static u16 scanline = 0;
static void (*line_handler)(void) = &blank_line; 

ISR(TIMER1_COMPA_vect)
{
	sei();
	asm("sleep\n");
}

ISR(TIMER1_COMPB_vect)
{
	line_handler();
	++scanline;
}

void blank_line(void)
{
	if(scanline == _NTSC_LINE_STOP_VSYNC)
	{
		OCR1A = _CYCLES_HSYNC;
	}
	else if(scanline == _NTSC_LINE_MID - (VIDEO_HEIGHT * CELL_HEIGHT) / 2)
	{
		TIMSK1 = (1 << OCIE1A) | (1 << OCIE1B);
		video_ptr = video_memory;
		line_handler = &active_line;
	}
	else if(scanline > _NTSC_LINE_FRAME)
	{
		OCR1A = _CYCLES_VSYNC;
		scanline = 0;
	}
}

void active_line(void)
{
	static uint8_t char_row;
	register uint8_t cnt;
	const register uint8_t *char_col, *char_ptr;

	char_ptr = video_ptr;
	char_col = font + ((uint16_t)char_row << 7);
	UDR0 = 0;
	UCSR0B = (1 << TXEN0);
	for(cnt = 0; cnt < VIDEO_WIDTH; ++cnt, ++char_ptr)
	{
		UDR0 = pgm_read_byte(char_col + *char_ptr);
	}

	while((UCSR0A & (1 << TXC0)) == 0);
	UDR0 = 0;
	UCSR0B = 0;
	if(++char_row == CELL_HEIGHT)
	{
		char_row = 0;
		if(scanline == _NTSC_LINE_MID + (VIDEO_HEIGHT * CELL_HEIGHT) / 2)
		{
			TIMSK1 = (1 << OCIE1B);
			line_handler = &blank_line;
			flag = 1;
		}
		else
		{
			video_ptr += VIDEO_WIDTH;
		}
	}
}

int main(void)
{
	u8 cnt, x, y, c, cv;
	x = 0;
	y = 0;
	cv = 1;
	cnt = 0;

	DDRC |= (1 << 0);
	SPCR = (1 << SPE);

	/* tv text */
	UBRR0 = 0;
	XCK_DIR |= (1 << XCK_PIN);
	UCSR0C = (1 << UMSEL00) | (1 << UMSEL01);
	VIDEO_DIR |= (1 << VIDEO_PIN);
	SYNC_DIR |= (1 << SYNC_PIN);
	VIDEO_OUT &= ~(1 << VIDEO_PIN);
	SYNC_OUT |= (1 << SYNC_PIN);
	TCCR1A = (1 << COM1A1) | (1 << COM1A0) | (1 << WGM11);
	TCCR1B = (1 << WGM13) | (1 << WGM12) | (1 << CS10);
	ICR1 = _NTSC_CYCLES_SCANLINE;
	OCR1A = _CYCLES_HSYNC;
	OCR1B = _NTSC_CYCLES_OUTPUT_START - 79;
	TIMSK1 = (1 << OCIE1B);
	TIMSK0 = 0;
	SMCR = (1 << SE);
	sei();

	for(;;)
	{
		if(flag)
		{
			++cnt;
			if(cnt == 15)
			{
				cnt = 0;
				if(cv)
				{
					video_memory[0] ^= (1 << 7);
				}
				else
				{
					video_memory[0] &= ~(1 << 7);
				}
			}

			PORTC |= (1 << 0);
			for(;;)
			{
				c = spi_receive();
				if(c == '\0')
				{
					break;
				}
				else if(c == '\n')
				{
					x = 0;
					++y;
				}
				else
				{
					video_memory[y * VIDEO_WIDTH + x] = c;
					++x;
				}

				if(x == VIDEO_WIDTH)
				{
					x = 0;
					++y;
				}

				if(y == VIDEO_HEIGHT)
				{
					--y;
					x = 0;
					memmove(video_memory, video_memory + VIDEO_WIDTH, VIDEO_WIDTH * (VIDEO_HEIGHT - 1));
					memset(video_memory + VIDEO_WIDTH * (VIDEO_HEIGHT - 1), ' ', VIDEO_WIDTH);
				}
			}

			PORTC &= ~(1 << 0);
			flag = 0;
		}
	}

	return 0;
}

